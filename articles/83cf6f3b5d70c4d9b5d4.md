---
title: "DATA-DOG/go-txdbã§DBæ¥ç¶šã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã‚’æ¥½ã«æ›¸ã“ã†"
emoji: "ğŸ‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go"]
published: true
---

# DBæ¥ç¶šã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã¯ãƒ„ãƒ©ã‚¤

- ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«ç”¨æ„ã—ãªã„ã¨ã„ã‘ãªã„ã€‚
- DBã®å¤‰æ›´çµæœãŒä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆã—ãªã„ã¨ã„ã‘ãªã„ã€‚
- DBã¸ã®å¤‰æ›´ãŒä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã®ã§ä¸¦åˆ—å®Ÿè¡Œã§ããªã„ã€‚

# DATA-DOG/go-txdbã‚’ä½¿ã†ã¨æ”¹å–„ã§ãã‚‹

- [DATA-DOG/go-txdb](https://github.com/DATA-DOG/go-txdb) ã§ç”Ÿæˆã™ã‚‹ã“ã¨ã®ã§ãã‚‹DBã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã«ã¯â†“ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚
  - `sql.DB`ã¨äº’æ›æ€§ãŒã‚ã‚‹ã€‚
  - ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªãŒç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
  - `.Close()`ã‚’å‘¼ã¶ã¨ãã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒªãŒã™ã¹ã¦Rollbackã•ã‚Œã‚‹ã€‚
- ã“ã‚Œã‚’ã†ã¾ãä½¿ã†ã¨ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã€ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«DBå¤‰æ›´ãŒRollbackã•ã‚Œã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒå¿…è¦ãªããªã‚Šã€ä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¸ã®å½±éŸ¿ã‚‚ãªããªã‚‹ã®ã§ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- å®Ÿéš›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ [ã“ã¡ã‚‰](https://github.com/rinchsan/txdb-todo) ã«ç½®ã„ã¦ã„ã¾ã™ã€‚

# è»½ã„è§£èª¬

## [`pkg/dao/dao_test.go`](https://github.com/rinchsan/txdb-todo/blob/master/pkg/dao/dao_test.go)

- ä»Šå›ã¯DBæ¥ç¶šã‚’å«ã‚€ã‚³ãƒ¼ãƒ‰ã‚’`dao`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ç½®ãã¾ã™ã€‚
- `TestMain`ã‚’å®šç¾©ã—ã¦ã€ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ [go-testfixtures/testfixtures](https://github.com/go-testfixtures/testfixtures) ã‚’ä½¿ã£ã¦æŒ¿å…¥ã—ã¾ã™ã€‚
  - `testfixtures`ã¯å¹³è¡Œãƒ†ã‚¹ãƒˆã«å¯¾å¿œã—ã¦ã„ãªã„ã“ã¨ãŒREADMEã«ã‚‚æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯`TestMain`ã§ã—ã‹å‘¼ã°ã‚Œãªã„ã®ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
- å¾Œã®ãƒ†ã‚¹ãƒˆã§`txdb`ã‚’ä½¿ã†ãŸã‚ã«`txdb.Register`ã‚’å‘¼ã‚“ã§ãŠãã¾ã™ã€‚

```go
func TestMain(m *testing.M) {
	prepare()

	txdb.Register("txdb", "mysql", config.DB.DSN)

	code := m.Run()
	os.Exit(code)
}

func prepare() {
	db, err := sql.Open(config.DB.Driver, config.DB.DSN)
	if err != nil {
		panic(err)
	}
	defer db.Close()

	fixtures, err := testfixtures.New(
		testfixtures.Database(db),
		testfixtures.Dialect("mysql"),
		testfixtures.Directory("/go/src/github.com/rinchsan/txdb-todo/testdata/fixtures"),
	)
	if err != nil {
		panic(err)
	}

	if err := fixtures.Load(); err != nil {
		panic(err)
	}
}
```

## [`pkg/dao/user_test.go`](https://github.com/rinchsan/txdb-todo/blob/master/pkg/dao/user_test.go)

- ãƒ¦ãƒ¼ã‚¶è¿½åŠ ã®ãƒ†ã‚¹ãƒˆã‚’ä¾‹ã«å–ã‚Šã¾ã™ã€‚
  - ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã‚„DBã®ã‚¹ã‚­ãƒ¼ãƒãªã©ã®è©³ç´°ã¯GitHubã®ã»ã†ã‚’è¦‹ã¦ãã ã•ã„ã€‚
- `sql.Open`ã«æ¸¡ã™Driverã«`"txdb"`ã‚’æŒ‡å®šã—ã¦å–å¾—ã—ãŸã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’ã—ã¦ã„ãã¾ã™ã€‚
  - `sql.Open`ã®ç¬¬2å¼•æ•°ã«æ¸¡ã™æ–‡å­—åˆ—ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚
- `defer`ã§å‘¼ã‚“ã§ã„ã‚‹`db.Close()`ã«ã‚ˆã£ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«DBã®å¤‰æ›´ãŒRollbackã•ã‚Œã¦ã„ã¾ã™ã€‚
- `t.Parallel()`ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å¹³è¡Œã«èµ°ã‚‰ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
- ã¡ãªã¿ã«ä»Šå›ã®ä¾‹ã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã«ä½¿ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã¯åˆ¥ã®ã‚‚ã®ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã®ã§ã€è©³ã—ãã¯ [`Makefile`](https://github.com/rinchsan/txdb-todo/blob/master/Makefile) ã®`test`ã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

```go
func TestUserImpl_Add(t *testing.T) {
	t.Parallel()

	cases := map[string]struct {
		user  *entity.User
		noErr bool
	}{
		"new user": {
			user:  &entity.User{Username: "rinchsan"},
			noErr: true,
		},
		"duplicate username": {
			user:  &entity.User{Username: "John"},
			noErr: true,
		},
		"empty username": {
			user:  &entity.User{Username: ""},
			noErr: true,
		},
	}

	for name, c := range cases {
		c := c
		t.Run(name, func(t *testing.T) {
			t.Parallel()

			db, err := sql.Open("txdb", uuid.New().String())
			assert.NoError(t, err)
			defer db.Close()
			impl := dao.NewUser(db)

			err = impl.Add(context.Background(), c.user)
			if c.noErr {
				assert.NoError(t, err)
			} else {
				assert.Error(t, err)
			}
		})
	}
}
```

# æ„Ÿæƒ³

ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆã‚’gomockã¨ã‹ã‚’ä½¿ã£ã¦æ›¸ãã¨ã€ä»Šå›ã®txdbã¨åˆã‚ã›ã¦çµæ§‹ã„ã„æ„Ÿã˜ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ãã†ã§ã™ã€‚
