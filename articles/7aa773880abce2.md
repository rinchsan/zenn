---
title: "Next-gen Slack platformã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹"
emoji: "ğŸ‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Slack", "Deno"]
published: true
---

# ã²ã¨ã¾ãšå®Œå…¨ã«ç†è§£ã™ã‚‹

:::message
è‡ªåˆ†ã§å®Œå…¨ã«ç†è§£ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ â†’ [https://api.slack.com/future](https://api.slack.com/future)
:::

```mermaid
graph LR
T1((Trigger 1)) -- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸ --> W{Workflow 1}
T2((Trigger 2)) -- ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆã•ã‚ŒãŸ --> W
W -- çµ„ã¿åˆã‚ã›ã¦ --> F1(Function 1)
W -- å‡¦ç†ã‚’å®Ÿè£… --> F2(Function 2)
```

## Trigger

### ãªã«ãã‚Œ

- ä½•ã‹ã—ã‚‰ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§Workflowã‚’å‘¼ã³å‡ºã™ã‚„ã¤
- ç¨®é¡ã«ã‚ˆã£ã¦å—ã‘å–ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã„ã‚ã„ã‚

### ä¾‹

- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šæœŸçš„ã«
- æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«ãŒä½œæˆã•ã‚ŒãŸ
- æ–°ã—ã„çµµæ–‡å­—ãŒä½œæˆã•ã‚ŒãŸ
- ãƒ¡ãƒƒã‚»ãŒæŠ•ç¨¿ã•ã‚ŒãŸ
- ãƒ¡ãƒƒã‚»ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒä»˜ã„ãŸ
- etc

### ãªã‚“ã§åˆ†é›¢ã•ã‚Œã¦ã‚‹ï¼Ÿ

- åŒã˜Workflowã‚’è‰²ã€…ãªãƒˆãƒªã‚¬ã§å‘¼ã³å‡ºã™ãŸã‚
    - `channel_created` ã¨ `channel_renamed` ã§åŒã˜Workflowã‚’å‘¼ã³å‡ºã™ã¨ã‹

## Workflow

### ãªã«ãã‚Œ

- Functionã‚’Stepã¨ã—ã¦çµ„ã¿åˆã‚ã›ã¦ã‚„ã‚ŠãŸã„ã“ã¨ã‚’å®Ÿè£…ã™ã‚‹ã‚„ã¤
- Triggerã‹ã‚‰å…¥åŠ›ã‚’å—ã‘å–ã‚‹

### ä¾‹

- æ–°ã—ãä½œæˆã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ã‚’ãŠçŸ¥ã‚‰ã›
- æ–°ã—ãä½œæˆã•ã‚ŒãŸçµµæ–‡å­—ã‚’ãŠçŸ¥ã‚‰ã›

### ãªã‚“ã§åˆ†é›¢ã•ã‚Œã¦ã‚‹ï¼Ÿ

- Triggerã¨Functionç¾¤ã‚’æ©‹æ¸¡ã—ã™ã‚‹ãŸã‚

## Function

### ãªã«ãã‚Œ

- ãƒ†ã‚¹ãƒˆå¯èƒ½ãªå˜ä½ã«å‡¦ç†ã‚’åˆ†å‰²ã—ã¦å®Ÿè£…ã™ã‚‹ã‚„ã¤
- å…¥åŠ›ã¨å‡ºåŠ›ã‚’æŒã¤

### ä¾‹

- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸæ–‡å­—åˆ—ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹
- æŠ•ç¨¿ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡å­—åˆ—ã‚’ä½œã‚‹
- Built-inãªFunctionã‚‚
    - `Schema.slack.functions.SendMessage`
    - `Schema.slack.functions.OpenForm`

### ãªã‚“ã§åˆ†é›¢ã•ã‚Œã¦ã‚‹ï¼Ÿ

- ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ã™ã‚‹ãŸã‚
- å†åˆ©ç”¨æ€§ã‚’ä¸Šã’ã‚‹ãŸã‚
- é…å¸ƒã—ã‚„ã™ãã™ã‚‹ãŸã‚

# å§‹ã‚æ–¹ã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹

:::message
è‡ªåˆ†ã§å®Œå…¨ã«ç†è§£ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ â†’ [https://api.slack.com/future/quickstart](https://api.slack.com/future/quickstart)
:::

â†“ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¯å…¨éƒ¨å…¥ã‚Šã¾ã™ï¼ˆMac / Linuxã®å ´åˆï¼‰ï¼ˆ`deno` ã¯Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ï¼‰ã€‚

```bash
curl -fsSL https://downloads.slack-edge.com/slack-cli/install.sh | bash
```

â†“ã‚’å®Ÿè¡Œã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’Slackã«è²¼ã‚Šä»˜ã‘ã¦æŠ•ç¨¿ã™ã‚‹ã ã‘ã§èªè¨¼å®Œäº†ã€‚

```bash
slack login
```

â†“ã‚’å®Ÿè¡Œã—ã¦ä½¿ã£ã¦ã‚‹WorkspaceãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰æº–å‚™OKã§ã™ã€‚

```bash
slack info
```

â†“ã‚’å®Ÿè¡Œã—ã¦é››å½¢ã‚’ã¨ã‚Šã‚ãˆãšä½œæˆã§ãã¾ã™ã€‚

```bash
slack create [name] --template https://github.com/slack-samples/deno-starter-template
```

# Triggerã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹

:::message
è‡ªåˆ†ã§å®Œå…¨ã«ç†è§£ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ â†’ [https://api.slack.com/future/triggers](https://api.slack.com/future/triggers)
:::

ä¾‹ãˆã°ã€Œãƒãƒ£ãƒ³ãƒãƒ«ãŒæ–°è¦ä½œæˆã•ã‚ŒãŸã¨ãã€ã®Triggerã¯ã“ã¡ã‚‰ã€‚

```tsx
import { Trigger } from "deno-slack-api/types.ts";
import NotifyWorkflow from "../workflows/notify.ts";

const notifyTrigger: Trigger<typeof NotifyWorkflow.definition> = {
  type: "event",
  name: "Notify channel created",
  description: "Notify channel created",
  workflow: "#/workflows/notify_workflow",
  inputs: {
    new_channel_id: {
      value: "{{data.channel_id}}",
    },
    new_channel_name: {
      value: "{{data.channel_name}}",
    },
  },
  event: {
    event_type: "slack#/events/channel_created",
  },
};

export default notifyTrigger;
```

:::message
ã€Œ`type` ã«æŒ‡å®šã§ãã‚‹ã‚‚ã®ã€ã‚„ã€Œ`data` ã‹ã‚‰å–ã‚Œã‚‹ã‚‚ã®ã€ ã¯ã“ã¡ã‚‰ â†’ [https://api.slack.com/future/triggers#types](https://api.slack.com/future/triggers#types)
:::

Triggerã‚’ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã—ã¾ã™ã€‚Triggerã¯Workflowã¨ã¯åˆ¥ã«ç‹¬ç«‹ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤(?)ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
slack trigger create --trigger-def triggers/channel_created.ts
slack trigger update --trigger-def triggers/channel_created.ts --trigger-id ABCDE12345
slack trigger delete --trigger-id ABCDE12345
```

# Workflowã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹

:::message
è‡ªåˆ†ã§å®Œå…¨ã«ç†è§£ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ â†’ [https://api.slack.com/future/workflows](https://api.slack.com/future/workflows)
:::

ä¾‹ãˆã°ã€Œè‡ªåˆ†ã§å®Ÿè£…ã—ãŸ `SendMessageFunctionDefinition` ã‚’å‘¼ã³å‡ºã™ã€ã®Workflowã¯ã“ã¡ã‚‰ã€‚

WorkflowãŒå—ã‘å–ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ `DefineWorkflow` ã® `input_parameters` ã§æŒ‡å®šã—ã¦ã€ `addStep` ã™ã‚‹ã¨ãã« `XxxWorkflow.inputs` ã‹ã‚‰å–ã‚Šå‡ºã—ã¾ã™ã€‚

`addStep` ã—ãŸFunctionã®å‡ºåŠ›ã‚’åˆ¥ã®Stepã§ä½¿ã„ãŸã„å ´åˆã¯ã€ `addStep` ã®è¿”ã‚Šå€¤ã‚’å¤‰æ•° `xxxStep` ã«æ ¼ç´ã—ã¦ `xxxStep.outputs` ã§å–ã‚Šå‡ºã—ã¾ã™ã€‚

```tsx
import { DefineWorkflow, Schema } from "deno-slack-sdk/mod.ts";
import { SendMessageFunctionDefinition } from "../functions/send_message.ts";

const NotifyWorkflow = DefineWorkflow({
  callback_id: "notify_workflow",
  title: "Notify new channel",
  description: "Notify new channel",
  input_parameters: {
    properties: {
      new_channel_id: {
        type: Schema.types.string,
      },
      new_channel_name: {
        type: Schema.types.string,
      },
    },
    required: ["new_channel_id", "new_channel_name"],
  },
});

NotifyWorkflow.addStep(SendMessageFunctionDefinition, {
  new_channel_id: NotifyWorkflow.inputs.new_channel_id,
  new_channel_name: NotifyWorkflow.inputs.new_channel_name,
});

export default NotifyWorkflow;
```

Triggerã¨ã¯åˆ¥ã«Workflowã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚Workflowã¯â†“ã®ã‚ˆã†ã« `manifest.ts` ã® `workflows` ã«æŒãŸã›ã¦ `$ slack deploy` ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ãƒ‡ãƒãƒƒã‚°ã™ã‚‹å ´åˆã¯ `$ slack run` ãŒä¾¿åˆ©ã§ã™ã€‚

```tsx
import { Manifest } from "deno-slack-sdk/mod.ts";
import NotifyWorkflow from "./workflows/notify.ts";

export default Manifest({
  name: "notify-new-channel",
  description: "Notify new channel created/renamed",
  icon: "assets/icon.png",
  workflows: [NotifyWorkflow],
  outgoingDomains: [],
  botScopes: [
    "commands",
    "chat:write",
    "chat:write.public",
    "channels:read",
  ],
});
```

# Functionã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹

:::message
è‡ªåˆ†ã§å®Œå…¨ã«ç†è§£ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ â†’ [https://api.slack.com/future/functions](https://api.slack.com/future/functions)
ã¨ã“ã¡ã‚‰ â†’ [https://api.slack.com/future/functions/custom](https://api.slack.com/future/functions/custom)
:::

ä¾‹ãˆã°ã€Œãƒãƒ£ãƒ³ãƒãƒ«åã¨ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’å—ã‘å–ã£ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œã£ã¦æŠ•ç¨¿ã™ã‚‹ã€ã®Functionã¯ã“ã¡ã‚‰ã€‚
â†’ [https://github.com/rinchsan/notify-new-channel/blob/main/functions/send_message.ts](https://github.com/rinchsan/notify-new-channel/blob/main/functions/send_message.ts)

`inputs` ã¨ã¯åˆ¥ã§å—ã‘å–ã‚Œã‚‹ `env` ã¯â†“ã‚’å®Ÿè¡Œã—ã¦è¨­å®šã§ãã¾ã™ã€‚Slackã®ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã«æš—å·åŒ–ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚

```bash
slack env add my-key secret-value
```

ã•ã‚‰ã«ã€ `inputs` ã¨ `env` ã«åŠ ãˆã¦å—ã‘å–ã‚Œã‚‹ `client` ã¯Slack APIã‚’å‘¼ã³å‡ºã›ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã€‚

# Functionã®ãƒ†ã‚¹ãƒˆã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹

:::message
Functionã®ãƒ†ã‚¹ãƒˆã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å…¨ç„¶ãªã„ã§ã™ã€‚Slackã•ã‚“è¿½åŠ ã—ã¦ãã‚Œï¼
:::

â†‘ã§ä¾‹ã«å‡ºã—ãŸFunctionã®ãƒ†ã‚¹ãƒˆã¯ã“ã¡ã‚‰ã€‚
â†’ [https://github.com/rinchsan/notify-new-channel/blob/main/functions/send_message_test.ts](https://github.com/rinchsan/notify-new-channel/blob/main/functions/send_message_test.ts)

`deno-slack-sdk/mod.ts` ã® `SlackFunctionTester` ãŒã¨ã¦ã‚‚ä¾¿åˆ©ã§ã€è¿”ã‚Šå€¤ã® `createContext` ã‚’ä½¿ãˆã°ã¨ã¦ã‚‚ç°¡å˜ã«ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã¦ä¾¿åˆ©ã§ã™ã€‚

`createContext` ã‚’ä½¿ã†ã¨ `client` ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Stub(?)ã—ã¦ãã‚Œã‚‹ã‚“ã§ã™ãŒã€ãŠãã‚‰ãæ­£å¸¸ç³»ã—ã‹ãƒ†ã‚¹ãƒˆå‡ºæ¥ãªã„ã®ã§ã€API Callã‚’æŸ”è»Ÿã«ãƒ¢ãƒƒã‚¯ã—ãŸã„å ´åˆã¯ [`deno.land/x/mock_fetch`](https://deno.land/x/mock_fetch) ãªã©ã‚’ä½¿ã†ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

ã¡ãªã¿ã«ã€â†“ã®ã‚³ãƒãƒ³ãƒ‰ç¾¤ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¤ã¤ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¨ˆæ¸¬ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¦ä¾¿åˆ©ã§ã™ã€‚ `coverage` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã¾ã  `UNSTABLE` ãªã®ã§ã”æ³¨æ„ã‚’ã€‚

```bash
deno test --allow-net --coverage=cover
deno coverage cover/
rm -rf cover/
```

# ãã®ä»–ä¾¿åˆ©ãªæ©Ÿèƒ½ã‚’å®Œå…¨ã«ç†è§£ã™ã‚‹

## [Logging](https://api.slack.com/future/logging)

`console.log` ã§å‡ºåŠ›ã—ãŸãƒ­ã‚°ã‚’â†“ã§è¦‹ã‚Œã¾ã™ã€‚ä¾¿åˆ©ã€‚

```bash
slack activity --tail
```

## [Datastore](https://api.slack.com/future/datastores)

è©³ç´°ã¯~~æ›¸ãã®ã‚ã‚“ã©ãã•ã„ã®ã§~~å¤šæ©Ÿèƒ½ã™ãã‚‹ã®ã§å‰²æ„›ã—ã¾ã™ãŒã€ãªã‚“ã¨ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚‚ä½¿ãˆã¾ã™ã€‚

## [VSCode Extension](https://marketplace.visualstudio.com/items?itemName=denoland.vscode-deno)

Denoã®VSCode ExtensionãŒã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚ã‚ã£ã¡ã‚ƒè‰²ã€…è£œå®ŒãŒåŠ¹ãã®ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦‹ãªãã¦ã‚‚ã‚³ãƒ¼ãƒ‰æ›¸ã‘ã¾ã™ã€‚

## [Permissions](https://api.slack.com/future/admin)

Workspaceå†…ã®ã©ã®Userã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’ä»˜ã‘ã‚‹ã‹é¸ã¹ã¾ã™ã€‚

## [Collaborations](https://api.slack.com/future/faq#collaboration)

è¤‡æ•°äººã§åŒã˜Slack Appã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚ãŸã ãƒãƒ¼ãƒ ã§é–‹ç™ºã™ã‚‹ãªã‚‰ã„ã„æ„Ÿã˜ã«CI/CDã‚’çµ„ã‚“ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’çµ„ã¿ãŸã„ã¨ã“ã‚ã€‚

# å®Œå…¨ã«ç†è§£ã—ãŸãœï¼

ã˜ã‚ƒã‚ãªã‚“ã‹ä½œã‚ã†ï¼

ä¾‹ã«ä½¿ã£ãŸã€Œæ–°ã—ããƒãƒ£ãƒ³ãƒãƒ«ãŒCreate or Renameã•ã‚ŒãŸã‚‰é€šçŸ¥ã™ã‚‹ã€ã®Slack Appã®ã‚³ãƒ¼ãƒ‰å…¨ä½“ã¯ã“ã¡ã‚‰ã€‚
â†’ https://github.com/rinchsan/notify-new-channel
