---
title: "GitHub Actionsã§Terraformã®å®Ÿè¡Œã‚’è‡ªå‹•åŒ–ã™ã‚‹"
emoji: "ğŸ‚"
type: "tech"
topics: ["terraform", "githubactions"]
published: true
---

# ã©ã‚“ãªæ„Ÿã˜ã«è‡ªå‹•åŒ–ã—ãŸã„ã‹

- Pull Requestä½œæˆæ™‚ã«terraform planã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸã„ã€‚
- Pull Requestã‚’ãƒãƒ¼ã‚¸ã—ãŸã¨ãã«terraform applyã‚’å®Ÿè¡Œã—ãŸã„ã€‚
- tfstateã‚’ã„ã„æ„Ÿã˜ã«åˆ†ã‘ãŸã„ã€‚
- å¤‰æ›´ã—ãŸéƒ¨åˆ†ã ã‘terraformã‚’å®Ÿè¡Œã—ãŸã„ã€‚

# å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰

- https://github.com/rinchsan/terraform-github-actions
- ECRã®ãƒªãƒã‚¸ãƒˆãƒªã‚’1ã¤ä½œã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã§ã™ã€‚
- å…¬å¼ãŒå‡ºã—ã¦ã„ã‚‹ã€GitHub Actionsã§Terraformã‚’è‡ªå‹•åŒ–ã™ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯ [ã“ã¡ã‚‰](https://learn.hashicorp.com/tutorials/terraform/github-actions) ã«ã‚ã‚Šã¾ã™ã€‚

# è§£èª¬

## `plan.yml`

- planã¯PRä½œæˆæ™‚ã‚„å¤‰æ›´æ™‚ã«GitHub Actionsã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚

```yaml
name: Plan
on:
  pull_request:
    branches:
      - master
```

---

- `strategy.matrix` ã«ä½•ã‹é…åˆ—ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãã‚Œãã‚Œã‚’ä½¿ã£ã¦ä¸¦åˆ—ã«ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- 1ã¤ã® `tfstate` ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã« `strategy.matrix.dir` ã«è¿½è¨˜ã—ã¦ã„ãã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
    - Devç’°å¢ƒã€Stgç’°å¢ƒãªã©ã®ç’°å¢ƒã”ã¨ã« `resources/dev/` ã€ `resources/stg/` ãªã©ã«åˆ†å‰²ã—ã¦ `strategy.matrix.dir` ã«è¿½åŠ ã—ã¦ã„ãã®ãŒã‚ˆãã‚ã‚Šãã†ã§ã™ã€‚
    - `resources/dev/` é…ä¸‹ã§ã•ã‚‰ã« `resources/dev/api/` ã¨ã‹ `resources/dev/worker/` ã¿ãŸã„ãªæ„Ÿã˜ã§ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ã—ã¦ã„ãã®ã‚‚è‰¯ã•ãã†ã§ã™ã€‚
    - `resources/dev/ecs/` ã¨ã‹ `resources/dev/rds/` ã¿ãŸã„ã«ãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã”ã¨ã«åˆ†ã‘ã‚‹ã®ã‚‚ã‚¢ãƒªã‹ã‚‚ã§ã™ã€‚

```yaml
jobs:
  plan:
    name: Plan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: [
          resources/shd/ecs,
        ]
```

---

- ã¨ã‚Šã‚ãˆãšCheckoutã—ã¦ãã¦ã€ [technote-space/get-diff-action](https://github.com/technote-space/get-diff-action) ã‚’ä½¿ã£ã¦masterã¨ã®å·®åˆ†ã‚’å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚
    - è‡ªåˆ†ã§git diffã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã‚‚ã„ã„ã¨æ€ã†ã‚“ã§ã™ãŒã€é¢å€’ã§ã™ã‚ˆã­ã€‚
- ã“ã“ã§å–å¾—ã—ãŸå·®åˆ†ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã«ã‚ˆã£ã¦ã€ `matrix.dir` ã”ã¨ã« `terraform plan` ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹ã‚’å¾Œç¶šã®stepã§åˆ¤æ–­ã—ã¾ã™ã€‚
    - `id` ã«ä½•ã‹æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¦ãŠãã¨ã€å¾Œç¶šã®stepã§å®Ÿè¡Œçµæœãªã©ã‚’å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- å…ˆã»ã©æŒ‡å®šã—ã¦ã„ãŸ `strategy.matrix.dir` ã¯ `${{ matrix.dir }}` ã¿ãŸã„ãªæ„Ÿã˜ã§å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Check diff
        id: diff
        uses: technote-space/get-diff-action@v3.2.0
        with:
          PREFIX_FILTER: |
            modules
            ${{ matrix.dir }}
          SUFFIX_FILTER: .tf
```

---

- ä»Šå›ã¯AWSã‚’æƒ³å®šã—ã¦ã„ã‚‹ã®ã§AWSã®èªè¨¼ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚
- ã“ã“ã§ã¯æ™®é€šã«IAM Userã®ã‚­ãƒ¼ãƒšã‚¢ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€ä¼šç¤¾ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äº‹æƒ…ã«ã‚ˆã£ã¦AssumeRoleã¨ã‹ã§SessionTokenã‚’å–å¾—ã—ãªã„ã¨ã„ã‘ãªã‹ã£ãŸã‚Šã™ã‚‹å ´åˆã¯ã€é ‘å¼µã£ã¦ãã ã•ã„ã€‚

```yaml
      - name: Configure aws credentials
        if: steps.diff.outputs.diff
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
```

---

- Hashicorpå…¬å¼ãŒæä¾›ã—ã¦ã„ã‚‹ [hashicorp/setup-terraform](https://github.com/hashicorp/setup-terraform) ã‚’ä½¿ã£ã¦ `terraform` ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚
- `if` ã§ `steps.diff.outputs.diff` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ `Check diff` stepã§å·®åˆ†ãŒå¾—ã‚‰ã‚ŒãŸã¨ãã®ã¿å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```yaml
      - name: Setup terraform
        if: steps.diff.outputs.diff
        uses: hashicorp/setup-terraform@v1.2.0
        with:
          terraform_version: 0.13.2
```

---

- `terraform fmt` ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãŠãã¾ã™ã€‚
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¾ã§ã«ç›´ã‚Œã°ã„ã„ã®ã§ã€ã“ã“ã§ã¯ `continue-on-error: true` ã‚’æŒ‡å®šã—ã¦å¾Œç¶šã®stepã¯å®Ÿè¡Œã—ã¾ã™ã€‚

```yaml
      - name: Check format
        id: fmt
        if: steps.diff.outputs.diff
        run: terraform fmt -check -recursive
        working-directory: ${{ matrix.dir }}
        continue-on-error: true
```

---

- `${{ matrix.dir }}` ã§ `terraform init` ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚
- ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯Terraformã®Backendè¨­å®šã‚„Providerè¨­å®šãªã©ã‚’æ›¸ã„ãŸ `init.tf` ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã«ç”¨æ„ã™ã‚‹æƒ³å®šã§ã™ãŒã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±é€šåŒ–ã—ãŸã„å ´åˆã¯ãƒªãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã« `init/init.tf` ãªã©ã‚’ç”¨æ„ã—ã¦ã€ `${{ matrix.dir }}` ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰ `terraform init` ã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
    - `${{ matrix.dir }}` ã‚’å…ƒã« `tfstate` ã® `key` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ãŠå¿˜ã‚Œãªãã€‚

```yaml
      - name: Initialize
        id: init
        if: steps.diff.outputs.diff
        run: terraform init
        working-directory: ${{ matrix.dir }}
```

---

- `terraform get` ã§ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãªã©ã‚’è¡Œã„ã€ `terraform validate` ã§è¨­å®šã‚’æ¤œè¨¼ã—ã¾ã—ã‚‡ã†ã€‚

```yaml
      - name: Download modules
        if: steps.diff.outputs.diff
        run: terraform get
        working-directory: ${{ matrix.dir }}

      - name: Validate
        if: steps.diff.outputs.diff
        run: terraform validate
        working-directory: ${{ matrix.dir }}
```

---

- `terraform plan` ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚
- `terraform plan` ã§ `-no-color` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã¯ã€å¾Œç¶šã®stepã§PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™éš›ã«è¡¨ç¤ºãŒãŠã‹ã—ããªã‚‹ã®ã‚’é˜²ããŸã‚ã§ã™ã€‚

```yaml
      - name: Plan
        if: steps.diff.outputs.diff
        id: plan
        run: terraform plan -no-color
        working-directory: ${{ matrix.dir }}
        continue-on-error: true
```

---

- [actions/github-script](https://github.com/actions/github-script) ã‚’ä½¿ã£ã¦ `terraform fmt` ã‚„ `terraform plan` ã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚
- ã„ã¡ã„ã¡GitHub Actionsã®å®Ÿè¡Œçµæœãƒšãƒ¼ã‚¸ã¸è¡Œãå¿…è¦ãŒãªã„ã®ã§æ¥½ã§ã™ã­ã€‚
- ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä¸Šè¿°ã®å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã‚ã‚‹ã‚‚ã®ã‚’æ‹å€Ÿã—ã¦ã„ã¾ã™ã€‚

```yaml
      - name: Comment
        if: steps.diff.outputs.diff
        uses: actions/github-script@v3.0.0
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `## \`${{ matrix.dir }}\`
            #### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`${process.env.PLAN}\`\`\`

            </details>`;

            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
```

## `apply.yml`

- `terraform apply` ã¯masterãƒ–ãƒ©ãƒ³ãƒã¸ã®Pushæ™‚ã«å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚
- `strategy` ã¾ã‚ã‚Šã¯planã¨åŒæ§˜ã§ã™ã€‚

```yaml
name: Apply

on:
  push:
    branches:
      - master

jobs:
  apply:
    name: Apply
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: [
          resources/shd/ecs,
        ]
```

---

- applyã§ã¯æœ€æ–°ã®PRã®å·®åˆ†ã‚’è¦‹ã¦å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ãŸã„ã®ã§ã€ `ref` ã¨ `fetch-depth` ã‚’æŒ‡å®šã—ã¾ã™ã€‚
- `actions/checkout@v2` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã€ã¤ã¾ã‚Šä»Šå›ã®å ´åˆã¯PRã®ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã—ã‹fetchã—ã¦ãã‚Œãªã„ãŸã‚ã€ `HEAD^` ã¨ `HEAD` ã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« `fetch-depth: 2` ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```yaml
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2
```

---

- `terraform` ã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨AWSã®èªè¨¼ã¯planã¨åŒæ§˜ã«è¡Œã„ã¾ã™ã€‚

```yaml
      - name: Setup terraform
        uses: hashicorp/setup-terraform@v1.2.0
        with:
          terraform_version: 0.13.2

      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
```

---

- æœ€å¾Œã« `HEAD^` ã¨ã® `git diff` ã‚’å–ã£ã¦ã€ `resources/` ã‚‚ã—ãã¯ `modules/` ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã€ `terraform apply` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- å°ã•ã„ã§ã™ãŒã‚ã¾ã‚Šã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯æ›¸ããŸããªã„ãªã¨æ€ã†ã®ã§ã€ã„ã„æ„Ÿã˜ã«å·®åˆ†ã‚’å–å¾—ã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›¸ã„ã¦ã¿ãŸã„ã§ã™ã­ã€‚
- ã“ã®çµæœã¯GitHub Actionsã®å®Ÿè¡Œçµæœãƒšãƒ¼ã‚¸ã«è¡Œã£ã¦ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
    - ã‚‚ã—å¤±æ•—ã—ã¦ã„ãŸã‚‰æ–°ãŸã«ä¿®æ­£ãƒ–ãƒ©ãƒ³ãƒã‚’masterã‹ã‚‰åˆ‡ã£ã¦ãã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹å½¢ã§å¯¾å¿œã—ã¾ã—ã‚‡ã†ã€‚

```yaml
      - name: Apply
        run: |
          DIFF=$(git diff --name-only HEAD^ modules ${{ matrix.dir }})
          if [[ ${DIFF} = *resources* || ${DIFF} = *modules* ]]; then
            cd ${{ matrix.dir }}
            terraform init
            terraform get
            terraform apply
          fi
        shell: bash
```

# æ„Ÿæƒ³

Orbæœªå¯¾å¿œã®CircleCIã¨ã‹ã§é ‘å¼µã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ã¦å®Ÿç¾ã—ã¦ã„ãŸã®ã‚’ã‚ã‚‹ç¨‹åº¦ã‚­ãƒ¬ã‚¤ã«æ›¸ã‘ã¦ã„ã„æ„Ÿã˜ã§ã™ã€‚
